<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Genomic Data Warehouse</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- Include Plotly.js for data visualization -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <!-- Include Bootstrap for better styling -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-dna"></i> Genomic Data Warehouse
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#search">Search Data</a>
                    </li>
                    <!--
                    <li class="nav-item">
                        <a class="nav-link" href="#visualization">Visualization</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#api">API</a>
                    </li>
                        -->
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Header Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="jumbotron bg-light p-4 rounded">
                    <h1 class="display-4">Genomic Data Analysis Platform</h1>
                    <p class="lead">Search, analyze, and visualize genomic data with advanced filtering and visualization tools.</p>
                </div>
            </div>
        </div>

        <!-- Search Section -->
        <div class="row mb-5" id="search">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-search"></i> Search Genomic Data</h3>
                    </div>
                    <div class="card-body">
                        <form id="searchForm">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="searchQuery" class="form-label">Search Query</label>
                                    <input type="text" class="form-control" id="searchQuery" 
                                           placeholder="Search genes, symbols, chromosomes...">
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="chromosome" class="form-label">Chromosome</label>
                                    <select class="form-select" id="chromosome">
                                        <option value="">All Chromosomes</option>
                                        <option value="chr1">chr1</option>
                                        <option value="chr2">chr2</option>
                                        <option value="chr3">chr3</option>
                                        <option value="chr4">chr4</option>
                                        <option value="chr5">chr5</option>
                                        <!-- Add more chromosomes as needed -->
                                    </select>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="strand" class="form-label">Strand</label>
                                    <select class="form-select" id="strand">
                                        <option value="">All Strands</option>
                                        <option value="+">+ (Forward)</option>
                                        <option value="-">- (Reverse)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="startPosition" class="form-label">Start Position</label>
                                    <input type="number" class="form-control" id="startPosition" placeholder="e.g., 100">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="endPosition" class="form-label">End Position</label>
                                    <input type="number" class="form-control" id="endPosition" placeholder="e.g., 200">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="effect" class="form-label">Effect</label>
                                    <select class="form-select" id="effect">
                                        <option value="">All Effects</option>
                                        <option value="up">Up-regulated</option>
                                        <option value="down">Down-regulated</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-search"></i> Search
                                    </button>
                                    <button type="button" class="btn btn-secondary ms-2" onclick="clearSearch()">
                                        <i class="fas fa-times"></i> Clear
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="text-center d-none">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>Searching genomic data...</p>
        </div>

        <!-- Results Section -->
        <div class="row mb-5" id="resultsSection" style="display: none;">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h3><i class="fas fa-table"></i> Search Results</h3>
                        <div>
                            <button class="btn btn-sm btn-outline-primary" onclick="exportResults()">
                                <i class="fas fa-download"></i> Export CSV
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="visualizeResults()">
                                <i class="fas fa-chart-bar"></i> Visualize
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="resultsCount" class="mb-3"></div>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="resultsTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th>ID</th>
                                        <th>Chromosome</th>
                                        <th>Start</th>
                                        <th>End</th>
                                        <th>Strand</th>
                                        <th>Symbol</th>
                                        <th>ENSG</th>
                                        <th>Log2FC</th>
                                        <th>Effect</th>
                                        <th>Cell Line</th>
                                        <th>Condition</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="resultsTableBody">
                                    <!-- Results will be populated here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Pagination -->
                        <nav aria-label="Results pagination">
                            <ul class="pagination justify-content-center" id="pagination">
                                <!-- Pagination will be populated here -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>

        <!-- Visualization Section -->
        <div class="row mb-5" id="visualization" style="display: none;">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-chart-bar"></i> Data Visualization</h3>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="chartType" class="form-label">Chart Type</label>
                                <select class="form-select" id="chartType" onchange="updateVisualization()">
                                    <option value="scatter">Scatter Plot (Log2FC vs Position)</option>
                                    <option value="histogram">Histogram (Log2FC Distribution)</option>
                                    <option value="bar">Bar Chart (Effect Counts)</option>
                                    <option value="chromosome">Chromosome Distribution</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="colorBy" class="form-label">Color By</label>
                                <select class="form-select" id="colorBy" onchange="updateVisualization()">
                                    <option value="effect">Effect</option>
                                    <option value="chromosome">Chromosome</option>
                                    <option value="strand">Strand</option>
                                    <option value="cellline">Cell Line</option>
                                </select>
                            </div>
                        </div>
                        <div id="plotlyChart" style="height: 500px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- API Documentation Section -->
        <div class="row mb-5" id="api">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-code"></i> API Endpoints</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h5>Search Genomic Data</h5>
                                <div class="api-endpoint">
                                    <code>GET /genomicData?query={search_term}</code>
                                    <p class="text-muted mt-2">Search genomic data with optional query parameters.</p>
                                </div>
                                
                                <h5 class="mt-4">Get Single Record</h5>
                                <div class="api-endpoint">
                                    <code>GET /genomicData/{id}</code>
                                    <p class="text-muted mt-2">Retrieve a specific genomic data record by ID.</p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h5>Example Response</h5>
                                <pre class="bg-light p-3 rounded"><code>{
  "id": 1,
  "start": 100,
  "end": 200,
  "chr": "chr1",
  "strand": "+",
  "symbol": "GeneA",
  "ensg": "ENSG000001",
  "log2fc": 1.5,
  "effect": "up",
  "cellline": "CellLine1",
  "condition": "Condition1"
}</code></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Detail Modal -->
    <div class="modal fade" id="detailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Genomic Data Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="detailModalBody">
                    <!-- Details will be populated here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-dark text-light text-center py-3 mt-5">
        <div class="container">
            <p>&copy; 2025 Genomic Data Warehouse. All rights reserved.</p>
        </div>
    </footer>

    <!-- Font Awesome for icons -->
    <script src="https://kit.fontawesome.com/your-fontawesome-kit.js" crossorigin="anonymous"></script>
    
    <!-- Custom JavaScript -->
    <script src="js/charts.js"></script>
    <script>
        let currentResults = [];
        let currentPage = 1;
        const itemsPerPage = 10;

        // Search form handler
        document.getElementById('searchForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            await performSearch();
        });

        async function performSearch() {
            const query = document.getElementById('searchQuery').value;
            const chromosome = document.getElementById('chromosome').value;
            const strand = document.getElementById('strand').value;
            const effect = document.getElementById('effect').value;
            
            // Show loading indicator
            document.getElementById('loadingIndicator').classList.remove('d-none');
            document.getElementById('resultsSection').style.display = 'none';
            
            try {
                // Build query parameters
                const params = new URLSearchParams();
                if (query) params.append('query', query);
                if (chromosome) params.append('chr', chromosome);
                if (strand) params.append('strand', strand);
                if (effect) params.append('effect', effect);
                
                const response = await fetch(`/genomicData?${params.toString()}`);
                const data = await response.json();
                
                currentResults = Array.isArray(data) ? data : [data];
                displayResults(currentResults);
                
            } catch (error) {
                console.error('Search error:', error);
                alert('Error performing search. Please try again.');
            } finally {
                document.getElementById('loadingIndicator').classList.add('d-none');
            }
        }

        function displayResults(results) {
            const tbody = document.getElementById('resultsTableBody');
            const resultsCount = document.getElementById('resultsCount');
            
            tbody.innerHTML = '';
            resultsCount.innerHTML = `<strong>${results.length}</strong> results found`;
            
            if (results.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" class="text-center">No results found</td></tr>';
            } else {
                results.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.id}</td>
                        <td><span class="badge bg-primary">${item.chr}</span></td>
                        <td>${item.start}</td>
                        <td>${item.end}</td>
                        <td><span class="badge ${item.strand === '+' ? 'bg-success' : 'bg-warning'}">${item.strand}</span></td>
                        <td><strong>${item.symbol || 'N/A'}</strong></td>
                        <td><code>${item.ensg || 'N/A'}</code></td>
                        <td><span class="badge ${item.log2fc > 0 ? 'bg-success' : 'bg-danger'}">${item.log2fc}</span></td>
                        <td><span class="badge ${item.effect === 'up' ? 'bg-success' : 'bg-danger'}">${item.effect}</span></td>
                        <td>${item.cellline || 'N/A'}</td>
                        <td>${item.condition || 'N/A'}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-info" onclick="showDetails(${item.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
            
            document.getElementById('resultsSection').style.display = 'block';
        }

        async function showDetails(id) {
            try {
                const response = await fetch(`/genomicData/${id}`);
                const data = await response.json();
                
                const modalBody = document.getElementById('detailModalBody');
                modalBody.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Basic Information</h6>
                            <table class="table table-sm">
                                <tr><th>ID:</th><td>${data.id}</td></tr>
                                <tr><th>Chromosome:</th><td>${data.chr}</td></tr>
                                <tr><th>Start Position:</th><td>${data.start}</td></tr>
                                <tr><th>End Position:</th><td>${data.end}</td></tr>
                                <tr><th>Strand:</th><td>${data.strand}</td></tr>
                                <tr><th>Symbol:</th><td>${data.symbol || 'N/A'}</td></tr>
                                <tr><th>ENSG:</th><td>${data.ensg || 'N/A'}</td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6>Expression Data</h6>
                            <table class="table table-sm">
                                <tr><th>Log2FC:</th><td>${data.log2fc}</td></tr>
                                <tr><th>Effect:</th><td>${data.effect}</td></tr>
                                <tr><th>Initial RC:</th><td>${data.rc_initial || 'N/A'}</td></tr>
                                <tr><th>Final RC:</th><td>${data.rc_final || 'N/A'}</td></tr>
                                <tr><th>Cell Line:</th><td>${data.cellline || 'N/A'}</td></tr>
                                <tr><th>Condition:</th><td>${data.condition || 'N/A'}</td></tr>
                                <tr><th>Screen Type:</th><td>${data.screentype || 'N/A'}</td></tr>
                            </table>
                        </div>
                    </div>
                    ${data.sequence ? `
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6>Sequence</h6>
                            <pre class="bg-light p-3 rounded"><code>${data.sequence}</code></pre>
                        </div>
                    </div>` : ''}
                `;
                
                new bootstrap.Modal(document.getElementById('detailModal')).show();
                
            } catch (error) {
                console.error('Error fetching details:', error);
                alert('Error loading details. Please try again.');
            }
        }

        function clearSearch() {
            document.getElementById('searchForm').reset();
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('visualization').style.display = 'none';
            currentResults = [];
        }

        function visualizeResults() {
            if (currentResults.length === 0) {
                alert('No data to visualize. Please perform a search first.');
                return;
            }
            
            document.getElementById('visualization').style.display = 'block';
            updateVisualization();
        }

        function updateVisualization() {
            if (currentResults.length === 0) return;
            
            const chartType = document.getElementById('chartType').value;
            const colorBy = document.getElementById('colorBy').value;
            
            // This would call the charts.js functions
            if (window.createVisualization) {
                window.createVisualization(currentResults, chartType, colorBy);
            }
        }

        function exportResults() {
            if (currentResults.length === 0) {
                alert('No data to export. Please perform a search first.');
                return;
            }
            
            // Convert to CSV
            const headers = ['ID', 'Chromosome', 'Start', 'End', 'Strand', 'Symbol', 'ENSG', 'Log2FC', 'Effect', 'Cell Line', 'Condition'];
            const csvContent = [
                headers.join(','),
                ...currentResults.map(row => [
                    row.id, row.chr, row.start, row.end, row.strand,
                    row.symbol || '', row.ensg || '', row.log2fc, row.effect,
                    row.cellline || '', row.condition || ''
                ].join(','))
            ].join('\n');
            
            // Download CSV
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'genomic_data_export.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Load initial data on page load
        window.addEventListener('load', function() {
            // Optionally load some sample data or show welcome message
            console.log('Genomic Data Warehouse loaded successfully');
        });
    </script>
</body>
</html>
